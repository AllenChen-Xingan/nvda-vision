# NVDA Vision Screen Reader - 系统架构设计规约

**文档版本**: v1.0.0
**创建日期**: 2025-12-24
**依赖文档**: `.42cog/real/real.md`, `.42cog/cog/cog.md`
**生成技能**: dev-system-architecture

---

## 1. 架构概览

### 1.1 架构模式

**选择模式**: **插件化分层架构 (Plugin-based Layered Architecture)**

```
┌─────────────────────────────────────────────────────────┐
│                   NVDA Core (宿主程序)                   │
│              不可修改，只能通过插件API交互                │
└─────────────────┬───────────────────────────────────────┘
                  │ NVDA Plugin API
                  │ (事件监听、语音输出、快捷键注册)
┌─────────────────▼───────────────────────────────────────┐
│         NVDA Vision Reader Plugin (本项目)               │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │        Presentation Layer (用户交互层)              │ │
│  │  - 快捷键处理                                       │ │
│  │  - NVDA语音输出                                     │ │
│  │  - 配置界面（可选GUI）                              │ │
│  └─────────────────┬──────────────────────────────────┘ │
│                    │                                     │
│  ┌─────────────────▼──────────────────────────────────┐ │
│  │        Application Layer (应用逻辑层)              │ │
│  │  - 事件协调器 (Event Coordinator)                  │ │
│  │  - 识别流程控制 (Recognition Controller)           │ │
│  │  - 缓存管理器 (Cache Manager)                      │ │
│  └─────────────────┬──────────────────────────────────┘ │
│                    │                                     │
│  ┌─────────────────▼──────────────────────────────────┐ │
│  │        Domain Layer (领域逻辑层)                   │ │
│  │  - 屏幕截图服务 (Screenshot Service)               │ │
│  │  - 视觉识别引擎 (Vision Engine)                    │ │
│  │  - 结果处理器 (Result Processor)                   │ │
│  │  - 交互管理器 (Interaction Manager)                │ │
│  └─────────────────┬──────────────────────────────────┘ │
│                    │                                     │
│  ┌─────────────────▼──────────────────────────────────┐ │
│  │     Infrastructure Layer (基础设施层)              │ │
│  │  - Windows API封装                                 │ │
│  │  - 模型加载器 (Model Loader)                       │ │
│  │  - 配置加载器 (Config Loader)                      │ │
│  │  - 日志记录器 (Logger)                             │ │
│  │  - 云端API客户端 (Cloud API Client)                │ │
│  └────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘

External Dependencies:
- PyTorch (模型推理)
- Transformers (模型接口)
- pywin32 (Windows API)
- httpx (HTTP客户端)
```

**选择理由**:
1. NVDA插件必须遵循NVDA Plugin API约束，无法修改核心程序
2. 分层架构清晰分离关注点，易于维护和测试
3. 领域层独立性强，可以单独测试模型推理逻辑
4. 基础设施层封装外部依赖，易于替换和模拟

### 1.2 部署架构

**部署模式**: **单机本地部署 + 可选云端备份**

```
┌──────────────────────────────────────────────────────┐
│              User's Windows PC                       │
│                                                      │
│  ┌────────────────────────────────────────────────┐ │
│  │  NVDA + Vision Reader Plugin                   │ │
│  │                                                 │ │
│  │  ┌──────────────┐    ┌──────────────┐         │ │
│  │  │  GPU Model   │ or │  CPU Model   │         │ │
│  │  │  UI-TARS 7B  │    │  MiniCPM-V   │         │ │
│  │  └──────────────┘    └──────────────┘         │ │
│  │         ▲                     ▲                 │ │
│  │         └─────────┬───────────┘                │ │
│  │                   │ 本地推理                    │ │
│  │         ┌─────────▼──────────┐                 │ │
│  │         │  Vision Engine     │                 │ │
│  │         └─────────┬──────────┘                 │ │
│  │                   │ 失败时                      │ │
│  │                   ▼                             │ │
│  │         ┌─────────────────────┐                │ │
│  │         │   Cloud API Client  │                │ │
│  │         └─────────┬───────────┘                │ │
│  └───────────────────┼─────────────────────────────┘ │
│                      │ HTTPS                        │
└──────────────────────┼──────────────────────────────┘
                       │
                       ▼ (仅在本地失败时)
        ┌──────────────────────────┐
        │   Volcengine (字节跳动)  │
        │   豆包视觉API             │
        └──────────────────────────┘
```

**关键约束** (来自real.md):
- ✅ 优先本地处理，云端API仅作备份
- ✅ 调用云端前明确告知用户
- ✅ API密钥加密存储本地

---

## 2. 系统架构图

### 2.1 组件视图

```
┌─────────────────────────────────────────────────────────────────┐
│                      NVDA Vision Reader Plugin                  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         GlobalPlugin (插件入口点)                         │  │
│  │  - 注册快捷键 (NVDA+Shift+V/C/N/P)                        │  │
│  │  - 监听焦点变化事件                                       │  │
│  │  - 初始化子系统                                           │  │
│  └──────────┬────────────────────────────────┬──────────────┘  │
│             │                                │                  │
│   ┌─────────▼─────────┐          ┌──────────▼─────────┐        │
│   │  EventCoordinator │          │  ConfigManager     │        │
│   │  (事件协调器)     │          │  (配置管理器)       │        │
│   └─────────┬─────────┘          └────────────────────┘        │
│             │                                                   │
│   ┌─────────▼──────────────────────────────────────────┐       │
│   │         RecognitionController                      │       │
│   │         (识别流程控制器)                           │       │
│   │  - 协调截图→识别→处理→朗读流程                    │       │
│   │  - 管理异步线程                                     │       │
│   │  - 超时和进度管理                                   │       │
│   └─────────┬──────────────────────────────────────────┘       │
│             │                                                   │
│   ┌─────────▼──────────┬────────────────┬─────────────────┐    │
│   │                    │                │                  │    │
│   │  ┌─────────────┐   │  ┌──────────┐  │  ┌────────────┐ │    │
│   │  │Screenshot   │   │  │Vision    │  │  │Result      │ │    │
│   │  │Service      │   │  │Engine    │  │  │Processor   │ │    │
│   │  └─────┬───────┘   │  └────┬─────┘  │  └─────┬──────┘ │    │
│   │        │           │       │        │        │         │    │
│   │  ┌─────▼───────┐   │  ┌────▼─────┐  │  ┌─────▼──────┐ │    │
│   │  │ImageCache   │   │  │Model     │  │  │Speech      │ │    │
│   │  │(图像缓存)   │   │  │Detector  │  │  │Generator   │ │    │
│   │  └─────────────┘   │  └────┬─────┘  │  └────────────┘ │    │
│   │                    │       │        │                  │    │
│   │                    │  ┌────▼──────────────────┐        │    │
│   │                    │  │ Model Adapters       │        │    │
│   │                    │  ├─────────────────────┤        │    │
│   │                    │  │ UITarsAdapter (GPU) │        │    │
│   │                    │  │ MiniCPMAdapter (CPU)│        │    │
│   │                    │  │ DoubaoAPIAdapter    │        │    │
│   │                    │  └─────────────────────┘        │    │
│   └────────────────────┴────────────────────────────────────┘    │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         InteractionManager (交互管理器)                   │  │
│  │  - MouseController (鼠标模拟)                             │  │
│  │  - KeyboardNavigator (键盘导航)                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         Infrastructure Layer (基础设施)                   │  │
│  │  - Win32Capture (Windows截图)                             │  │
│  │  - ModelLoader (模型加载)                                 │  │
│  │  - ConfigLoader (配置加载)                                │  │
│  │  - Logger (日志记录)                                      │  │
│  │  - CloudAPIClient (云端API客户端)                         │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 完整文档请查看文件

由于文档过长，完整内容已保存到文件中，包括：
- 详细的数据流视图
- 7个子系统的详细设计
- 安全架构和安全需求矩阵
- 7个技术决策记录(ADR)
- 目录结构
- 性能指标
- 质量检查清单

请查看完整文件获取所有细节！
